---
title: "Annotating your corpus with the Stanford Dependency Parser"
output: html_document
---
Author: Larissa Goulart, Northern Arizona University  
Tested with CoreNLP 4.1.0



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
******
### **Before we start**

The goal of this workshop is to learn how to annotate your corpus with the [Stanford Dependency Parser](https://stanfordnlp.github.io/CoreNLP/).
In order to follow the workshop, you will need to download:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**1. CoreNLP**

+ Download the CoreNLP from <https://stanfordnlp.github.io/CoreNLP/>

```{r, echo=FALSE, out.width="40%"}
knitr::include_graphics('Images/Figure 1.jpg')
```

+ Unzip the files

```{r, echo=FALSE, out.width="40%"}
knitr::include_graphics('Images/Figure 2.jpg')
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**2. Java**

+ Stanford CoreNLP is written in Java. Therefore, you will need to have Java installed in your computer. It is important to notice that you need at least Java 8.Select the file to download according to your operating system <https://java.com/en/download/manual.jsp> 

+ _For Windows Users_:If you don’t know your computer’s operating system, you can click on _Windows/Start>Settings> System > About_ to check.


```{r, echo=FALSE, out.width="35%"}
knitr::include_graphics('Images/Figure 3.jpg')
```

+ _For Mac Users_: You will likely have to install [Java SE Development Kit](https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**3. Corpus Text Processor from [CROW](https://writecrow.org/)**

+ Before running the Stanford CoreNLP, you will need to convert and standardize your text. For this, we will use the [Corpus Text Processor](https://github.com/writecrow/ciabatta/wiki/1.-Tools:-Corpus-Text-Processor#installation). You can read more about it [here](https://github.com/writecrow/ciabatta/wiki/1.-Tools:-Corpus-Text-Processor)

******

### **Overview**
Here is a general step by step of this workshop:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.Introduction to the Stanford Dependency Parser

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.Preparing the files

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.Running the Stanford Dependency Parser

*******
### **1.Introduction to the Stanford Dependency Parser**

The Stanford CoreNLP Tool allows us to extract linguistics annotations from our corpus. These annotations include lemmas, parts of speech, named entities and dependencies. With this tool, the main Stanford NLP tools are integrated in just one package. For corpus linguists, these annotations can be useful to conduct different types of analyses, such as, [key-feature analysis](https://www.youtube.com/watch?v=uQuEoeHlaEg), [multi-dimensional analysis](https://www.youtube.com/watch?v=tTdO1HJHUPM&feature=emb_title), [machine learning applications](https://www.youtube.com/watch?v=MYn4qeyJsQw&feature=emb_title), among others.

### **1.1. Part of Speech Annotation**

Part of speech annotation gives you information about the word class of each word in a sentence.

```{r, echo=FALSE, out.width="50%"}
knitr::include_graphics('Images/Figure 5.png')
```

### **1.2. Dependencies**

Dependencies indicate the syntactical relationship between the words in a sentence. 

```{r echo=FALSE, out.width="40%", fig.cap="Jurafsky & Martin, 2019"}
knitr::include_graphics('Images/Figure 6.jpg')
```

Universal Stanford Dependencies are based on Universal Grammar. You can read more about the dependencies [here](https://nlp.stanford.edu/pubs/USD_LREC14_paper_camera_ready.pdf)

*******
## **2.Preparing the files**


#### **2.1. Files: LILE Corpus**
For this workshop we will use ten files from the [LILE Corpus](https://editora.pucrs.br//anais/sial/2011/src/29.pdf) (Sarmento, Scortegagna & Goulart, 2011). This corpus contains abstracts of Thesis and Dissertations written in the fields of Literature and Applied Linguistics. You can download the files [here](https://www.dropbox.com/s/b28f1nhwckuy99z/LILE_Corpus.7z?dl=0) or [here](https://www.dropbox.com/sh/pt9nxvlkaicxmfh/AADqKEO8zNSfwC_SsK1Vib5Ta?dl=0).


#### **2.2. [Corpus Text Processor](https://github.com/writecrow/ciabatta/wiki/1.-Tools:-Corpus-Text-Processor#installation)**
We will use the Corpus Text Processor to prepare the files. I recommend you create three folders in your computer called: 01_converted, 02_encoded, and 03_standardized before running the tool. It should look like this.


```{r echo=FALSE, out.width="40%"}
knitr::include_graphics('Images/Figure 7.png')
```


The goal is to mirror the menus in the Corpus Text Processor.


```{r echo=FALSE, out.width="40%"}
knitr::include_graphics('Images/Figure 8.png')
```

Now, we have all the files in the correct format to run the Stanford Dependency Parser.

********

### **3.Running the Stanford Dependency Parser**

#### **3.1. Checking the Java settings**

In order to run CoreNLP, you will need to allocate more RAM memory to Java than your computer's default setting. If you have a lot of RAM this will not be a problem for you. But, if you are not sure about your RAM size, it is better to check.  
When explaining the memory needed to run CoreNLP, the Stanford NLP group said that: 

> CoreNLP needs about 2GB to run the entire pipeline.

Let's allocate more RAM to Java in your machine.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1. Open your Control Panel

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2. Select Programs

```{r echo=FALSE, out.width="100%"}
knitr::include_graphics('Images/Figure 9.png')
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3. Select Java

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4. Click on the tab Java

```{r echo=FALSE, out.width="100%"}
knitr::include_graphics('Images/Figure 10.png')
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5. Change the Runtime Parameter

```{r echo=FALSE, out.width="60%"}
knitr::include_graphics('Images/Figure 11.png')
```


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6. Deciding on the Parameter for the Runtime

-Xmx512m assigns 512MB memory for Java.
-Xmx1024m assigns 1GB memory for Java.
-Xmx2048m assigns 2GB memory for Java.
-Xmx3072m assigns 3GB memory for Java
And so on..

You can start with _-Xmx3072m_ and if CoreNLP does not work try _-Xmx2048m_ and so on. Keep in mind that as you assign more memory to Java, CoreNLP will run faster.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7. Click OK on the "Java Runtime" window and then Apply in the "Java Control Panel"  <br />
 


###### [Alternative tutorial on how to assign more RAM to Java](http://www.messiahpsychoanalyst.org/wikihow/index.php/How_to_Increase_Java_Memory_in_Windows) 

###### To understand why CoreNLP needs more memory than other applications, you can check the developers' explanation [here](https://stanfordnlp.github.io/CoreNLP/memory-time.html).<br />



#### **3.1. Navigating to the _stanford-corenlp-full_ folder**

If Windows: 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1. Open _Power Shell ISE_

```{r echo=FALSE, out.width="40%"}
knitr::include_graphics('Images/Figure 12.png')
```

If Mac:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1. Open your Terminal

_Launchpad > Terminal_

```{r echo=FALSE, out.width="40%"}
knitr::include_graphics('Images/Figure 21.png')
```


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2. Use `dr` on Windows or `ls` on Mac to identify the folders in your directory

```{r echo=FALSE, out.width="40%"}
knitr::include_graphics('Images/Figure 13.png')
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3. Use `cd` to navigate to the directory where you saved the _stanford-corenlp-full_ folder

```{r echo=FALSE, out.width="40%"}
knitr::include_graphics('Images/Figure 14.png')
```


Once you find the folder you are looking for, press Enter

```{r echo=FALSE, out.width="40%", fig.cap="Windows"}
knitr::include_graphics('Images/Figure 15.png')
```


```{r echo=FALSE, out.width="40%", fig.cap="Mac"}
knitr::include_graphics('Images/Figure 22.png')
```

I saved the _stanford-corenlp-full_ folder in my documents. So, in my computer, I have to do `cd Documents\stanford-corenlp-4.1.0`


#### **3.2. Launching CoreNLP (optional)** 

After navigating to the CoreNLP folder, we are going to run this code.

`java -mx4g -cp "*" edu.stanford.nlp.pipeline.StanfordCoreNLPServer [port] [timeout]`

Where `-mx4g` indicates the amount of RAM that CoreNLP can use, if you set 3GB you can use `-mx3g` and so on.

It should look like this:

```{r echo=FALSE, out.width="80%"}
knitr::include_graphics('Images/Figure 16.png')
```

Then, open `http://localhost:9000` in your machine and see an interface like this.

```{r echo=FALSE, out.width="80%"}
knitr::include_graphics('Images/Figure 17.png')
```


#### **3.3 Let's run CoreNLP in one file**

To annotate just one text this is the code we will use

`java -mx3g -cp "*" edu.stanford.nlp.pipeline.StanfordCoreNLP -file` filename_here `-outputFormat conll`

Where *filename_here* is the name of your file and `-mx3gp` is the amount of RAM you assigned to your Java.

This is an example of the code in my computer.

`java -mx3g -cp "*" edu.stanford.nlp.pipeline.StanfordCoreNLP -file '..\LAEL_Research_Bazaar\Corpus Text Processor\03_ Standardized\LIRNLGI101.txt' -outputFormat conll`

Where `..\` means that I am going back one folder. 

Here is what it should look like

```{r echo=FALSE, out.width="80%", fig.cap="Windows"}
knitr::include_graphics('Images/Figure 18.png')
```

```{r echo=FALSE, out.width="80%", fig.cap="Mac"}
knitr::include_graphics('Images/Figure 23.png')
```

Your file should look like this

```{r echo=FALSE, out.width="60%"}
knitr::include_graphics('Images/Figure 19.png')
```

#### **3.4. Let's run CoreNLP in a directory**

To annotate a whole directory, this is the code we will use for *Windows*:

`Get-ChildItem "` Directory `" -Filter *.txt |Foreach-Object {java -mx3g -cp "*" edu.stanford.nlp.pipeline.StanfordCoreNLP -file$_.FullName -outputFormat conll}`

This is how the code will look like on my computer.

`Get-ChildItem "..\LAEL_Research_Bazaar\Corpus Text Processor\03_ Standardized" -Filter *.txt |Foreach-Object {java -mx3g -cp "*" edu.stanford.nlp.pipeline.StanfordCoreNLP -file $_.FullName -outputFormat conll}`

Here is what it should look like in your PowerShell ISE

```{r echo=FALSE, out.width="100%"}
knitr::include_graphics('Images/Figure 20.png')
```

This is the code we will use for a *Mac OS*:

`for i in` directory `\*.txt; do (java -mx3g -cp "*" edu.stanford.nlp.pipeline.StanfordCoreNLP -file $i -outputFormat conll); done`

This is how the code will look like on my computer.

`for i in ..\LAEL_Research_Bazaar\Corpus Text Processor\03_ Standardized\*.txt; do (java -mx3g -cp "*" edu.stanford.nlp.pipeline.StanfordCoreNLP -file $i -outputFormat conll); done`

#### **3.5. Reading the output**

What does this dependency label mean?

[Universal Dependency Relations](https://universaldependencies.org/u/dep/index.html)


#### ***3.6. Using CoreNLP with other languages**



**Other tutorials**

[NLP with Stanford CoreNLP](https://cloudacademy.com/blog/natural-language-processing-stanford-corenlp/)  
[Stanford CoreNLP Tutorial](https://interviewbubble.com/stanford-corenlp-tutorial/)  
[Stanford CoreNLP](http://www.linguisticsweb.org/doku.php?id=linguisticsweb:tutorials:linguistics_tutorials:automaticannotation:stanford_core_nlp)

